<!DOCTYPE html>
<html ng-app="PokeWatchApp">
	<head>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		<meta charset="utf-8">
		<title>PokeWatch Locations</title>
		<link href="//fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">
		<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/css/materialize.min.css">
		<script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false&key=AIzaSyDH834DQFJeDEIH-UkjiMR0UkXyEps-nvQ"></script>
		<script type="text/javascript" src="//code.jquery.com/jquery-3.1.0.min.js"></script>
		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
		<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
		<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/materialize/0.97.7/js/materialize.min.js"></script>
		<script type="text/javascript">
		var map;
		var locations=[];
		String.prototype.toHHMMSS = function () {
			var sec_num = parseInt(this, 10); // don't forget the second param
			var hours   = Math.floor(sec_num / 3600);
			var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
			var seconds = sec_num - (hours * 3600) - (minutes * 60);

			if (hours   < 10) {hours   = "0"+hours;}
			if (minutes < 10) {minutes = "0"+minutes;}
			if (seconds < 10) {seconds = "0"+seconds;}
			return hours+':'+minutes+':'+seconds;
		}
		function initialize(Lat,Lng) {
			var latlng = new google.maps.LatLng(Lat,Lng);
			var myOptions = {
			  zoom: 15,
			  center: latlng,
			  mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
			google.maps.event.addListener(map,"rightclick",function(event){showMapMenu(event.latLng,'.mapmenu');});
			google.maps.event.addListener(map,"click",function(event){hideContextMenu();});
		}
		function getCanvasXY(currentLatLng){
			var scale = Math.pow(2, map.getZoom());
			var nw = new google.maps.LatLng(
				map.getBounds().getNorthEast().lat(),
				map.getBounds().getSouthWest().lng()
			);
			var worldCoordinateNW = map.getProjection().fromLatLngToPoint(nw);
			var worldCoordinate = map.getProjection().fromLatLngToPoint(currentLatLng);
			var currentLatLngOffset = new google.maps.Point(
				Math.floor((worldCoordinate.x - worldCoordinateNW.x) * scale),
				Math.floor((worldCoordinate.y - worldCoordinateNW.y) * scale)
			);
			return currentLatLngOffset;
		}
		function setMenuXY(currentLatLng){
			var mapWidth = $('#map_canvas').width();
			var mapHeight = $('#map_canvas').height();
			var menuWidth = $('.cmenu').width();
			var menuHeight = $('.cmenu').height();
			var clickedPosition = getCanvasXY(currentLatLng);
			var x = clickedPosition.x ;
			var y = clickedPosition.y ;

			if((mapWidth - x ) < menuWidth)
				 x = x - menuWidth;
			if((mapHeight - y ) < menuHeight)
				y = y - menuHeight;

			$('.cmenu').css('left',x);
			$('.cmenu').css('top',y);
		};
		function showMapMenu(currentLatLng,menu) {
			var projection;
			var contextmenuDir;
			projection = map.getProjection() ;
			$('.cmenu').fadeOut(50);
			$(menu).fadeOut(50,function(){
				setMenuXY(currentLatLng);
				$(menu).fadeIn(50).find('.addArea').attr('onclick','addNewMarker' + currentLatLng + ';');
			});
		}
		function hideContextMenu() {
			$('.cmenu').fadeOut(50);
			$("#LocationsJSON").fadeOut(500);
		}
		function copyMarkerLocations(){
			$("#LocationsJSON,#LocationsJSON_hidden").text(JSON.stringify(locations, null, "\t"))
			try{
				$("#LocationsJSON_hidden").select();
				var successful = document.execCommand('copy');
				if (!successful) {
					throw 'copy unsuccessful';
				}
				swal({
					title: "Success!",
					text: "Copied Locations",
					type:"success",
					timer: 2000,
					showConfirmButton: false
				});
			}catch(err){
				console.log(err);
				$("#LocationsJSON").fadeIn(500)
				$("#LocationsJSON").select();
			}
		}
		$(document).ready(function(){
			navigator.geolocation.getCurrentPosition(function(location) {
				console.log(location);
				Lat = location.coords.latitude;
				Lng = location.coords.longitude;
				initialize(Lat,Lng);
			},function(error){
				initialize(40.782410,-73.965849);
				swal({title: "Warning!",text: "Could not determine your location,<br/>Please set your location on <strong>Line 114</strong> of this file<br/><pre>initialize(40.782410,-73.965849);</pre><br/>And then delete <strong>Line 115</strong>",type:"warning",html: true});
			});
		});
		
		var PokeWatchApp = angular.module('PokeWatchApp', []);
		PokeWatchApp.controller('PokeWatchController', function PokeWatchController($scope) {
			$scope.areas = JSON.parse(localStorage.getItem("areas")) || [{name:"Springfield",prefix:"around",suffix:"north",locations:[]}];
			$scope.AddArea = function () {
				$scope.areas.push({
					name: "New Location",
					prefix: "",
					suffix: "",
					locations:[]
				});
			};
			$scope.RemoveArea = function() {
				$scope.areas.splice(this.$index, 1);
			}
			
			//Add Single Marker
			$scope.addNewMarker = function(Lat,Lng,area) {
				var circle = new google.maps.Circle({
					strokeColor: '#27ae60',
					strokeOpacity: 0.8,
					strokeWeight: 2,
					fillColor: '#2ecc71',
					fillOpacity: 0.35,
					map: map,
					center: {"lat":Lat,"lng":Lng},
					radius: 70,
					draggable:true
				});
				google.maps.event.addListener(circle, "rightclick",function(event){showMapMenu(event.latLng,'.markermenu');});
				$scope.areas[area].locations.push(circle);
			}
			
			//Transform Rectangle to Markers
			$scope.makeCircle = function(){
				var bounds = rectangle.getBounds();
				var i=0;
				for (nextS = bounds.f.b; (nextS + (180/Math.PI)*(110/6378137)) > bounds.f.f; nextS -= (180/Math.PI)*(110/6378137)){
					nextEE = bounds.b.b;
					if (++i % 2 == 0){
						nextEE += (180/Math.PI)*(70/6378137)
					}
					for (nextE = nextEE; (nextE - (180/Math.PI)*(70/6378137)) < bounds.b.f; nextE += (180/Math.PI)*(140/6378137)){
						$scope.addNewMarker(nextS,nextE,this.$index);
					}
				}
				rectangle.setMap(null);
			}
			
			//Create a Rectangle to mass mark area
			var rectangle;
			$scope.makeRectangle = function(){
				rectangle = new google.maps.Rectangle({
					strokeColor: '#FF0000',
					strokeOpacity: 0.8,
					strokeWeight: 2,
					fillColor: '#FF0000',
					fillOpacity: 0.35,
					map: map,
					editable:true,
					draggable:true,
					bounds: {
						north: -36.78546986889685,	//f.b
						south: -36.78839127856238,	//f.f
						east: 174.76308345794678,	//b.f
						west: 174.75763320922852	//b.b
					}
				});
				google.maps.event.addListener(rectangle, "rightclick",function(event){showMapMenu(event.latLng,'.squaremenu');});
			}
		});
		</script>
		<style type="text/css">
		body{
			overflow:hidden;
			padding:0px;
			margin:0px;
		}
		
		#menu {
			position: fixed;
			right: 10px;
			top: 10px;
			z-index: 5;
			height: auto;
			width: 300px;
		}
		#map_canvas{
			width: 100vw; 
			height: 100vh;
		}
		.cmenu {
			position: absolute;
			display: none;
			min-width: 190px;
			background-color: #fff;
			box-shadow: 1px 2px 3px #aaa;
			z-index:50;
		}
		.cmenu * {
			transition: color .15s, background .4s;
		}
		.cmenu .item {
			position: relative;
			height: 48px;
			line-height: 48px;
			color: #2186fa;
			font-family: Roboto, Arial, sans-serif;
			cursor: pointer;
		}
		.cmenu .item:hover:not(.disabled) {
			background-color:#ddd;
		}
		.cmenu .item:last-child {
			margin-bottom: 5px;
		}
		.cmenu .item.disabled,
		.cmenu .item.disabled .label {
			color: #e5e5e5;
			cursor: default;
		}
		.cmenu .item .label {
			padding-left: 12px;
		}
		.cmenu .item ul.options {
			list-style: none;
			margin: 0;
			padding: 0;
			z-index: 50;
			background: #fff;
			position: relative;
			left: calc(50% - 24px);
			top: -24px;
			box-shadow: 1px 2px 3px #aaa;
		}
		.cmenu .item ul.options li {
			height: 40px;
			text-indent: 5px;
			position: relative;
		}
		.cmenu .item ul.options li:last-child {
			border-top: 1px solid rgba(77, 144, 254, 0.2);
		}
		#LocationsJSON{
			width:500px;
			height:80vh;
			position:absolute;
			top:10vh;
			left: calc(50vw - 260px);
			border-radius:30px;
			padding:10px;
			font-size:15px;
			display:none;
		}
		#LocationsJSON_hidden{
			position:absolute;
			top:-10px;
			width:0px;
			height:0px;
			z-index:-50px;
		}
		.collapsible-header {
			padding-right:0px;
		}
		.collapsible-body {
			background-color:#fcfcfc;
			padding:10px;
		}
		.input-field label {
			color: #2c3e50;
		}
		.input-field input[type=text]:focus + label,
		.input-field input[type=password]:focus + label {
			color: #2c3e50;
		}
		.input-field input[type=text]:focus,
		.input-field input[type=password]:focus {
			border-bottom: 1px solid #2c3e50;
			box-shadow: 0 1px 0 0 #2c3e50;
		}
		.input-field .prefix.active {
			color: #2c3e50;
		}
		.input-field input[type=text],
		.input-field input[type=password] {
			padding-left:10px;
		}
		.btn {
			margin:0px;
			width:100%;
		}
		::-webkit-scrollbar {
			width: 3px;
			height: 3px;
		}
		::-webkit-scrollbar-button {
			width: 0px;
			height: 0px;
		}
		::-webkit-scrollbar-thumb {
			background: #e1e1e1;
			border: 0px none #ffffff;
			border-radius: 50px;
		}
		::-webkit-scrollbar-thumb:hover {
			background: #ffffff;
		}
		::-webkit-scrollbar-thumb:active {
			background: #000000;
		}
		::-webkit-scrollbar-track {
			background: #666666;
			border: 0px none #ffffff;
			border-radius: 50px;
		}
		::-webkit-scrollbar-track:hover {
			background: #666666;
		}
		::-webkit-scrollbar-track:active {
			background: #333333;
		}
		::-webkit-scrollbar-corner {
			background: transparent;
		}
		</style>
	</head>
	<body ng-controller="PokeWatchController">
		<input type="text" style="display:none">
		<input type="password" style="display:none">
		<div class="container" id="menu" style="max-height:100vh;overflow-y:auto;autoflow-x:hidden;">
			<ul class="collapsible popout" data-collapsible="accordion">
				<li>
					<div class="collapsible-header"><i class="material-icons">supervisor_account</i>Pokemon GO Account</div>
					<div class="collapsible-body">
						<div class="input-field col s12">
							<input autocomplete="off" placeholder="(optional)" id="ptc_username" type="text">
							<label for="ptc_username">PTC Username</label>
						</div>
						<div class="input-field col s12">
							<input autocomplete="off" placeholder="********" id="ptc_password" type="password">
							<label for="ptc_password">PTC Password</label>
						</div>
						<div class="input-field col s12">
							<input autocomplete="off" placeholder="(optional)" id="google_username" type="text">
							<label for="google_username">Google Account Username</label>
						</div>
						<div class="input-field col s12">
							<input autocomplete="off" placeholder="********" id="ptc_username" type="password">
							<label for="google_password">Google Account Password</label>
						</div>
					</div>
				</li>
				<li>
					<div class="collapsible-header"><i class="material-icons">settings</i>Twitter Account</div>
					<div class="collapsible-body">
						<div class="input-field col s12">
							<input autocomplete="off" placeholder="required" id="google_username" type="text">
							<label for="google_username">Twitter Consumer Token</label>
						</div>
						<div class="input-field col s12">
							<input autocomplete="off" placeholder="required" id="google_username" type="text">
							<label for="google_username">Twitter Consumer Secret</label>
						</div>
						<div class="input-field col s12">
							<input autocomplete="off" placeholder="required" id="google_username" type="text">
							<label for="google_username">Twitter Access Token</label>
						</div>
						<div class="input-field col s12">
							<input autocomplete="off" placeholder="required" id="google_username" type="text">
							<label for="google_username">Twitter Access  Secret</label>
						</div>
					</div>
				</li>
				<li>
					<div class="collapsible-header"><i class="material-icons">place</i>Areas | {{ ((areas[0].locations*5).toString().toHHMMSS()) }}</div>
					<div class="collapsible-body">
						<ul class="collapsible" data-collapsible="accordion">
							<li ng-repeat="area in areas">
								<div class="collapsible-header"><i class="material-icons">grade</i>{{area.prefix}} {{area.name}} {{area.suffix}}</div>
								<div class="collapsible-body">
									<div class="input-field col s12">
										<input autocomplete="off" placeholder=" - " id="google_username" type="text" value="{{area.prefix}}">
										<label for="google_username">Prefix</label>
									</div>
									<div class="input-field col s12">
										<input autocomplete="off" placeholder=" - " id="google_username" type="text" value="{{area.name}}">
										<label for="google_username">Name</label>
									</div>
									<div class="input-field col s12">
										<input autocomplete="off" placeholder=" - " id="google_username" type="text" value="{{area.suffix}}">
										<label for="google_username">Suffix</label>
									</div>
									<a class="waves-effect waves-light btn red" data-ng-click="RemoveArea()">Remove</a>
								</div>
							</li>
						</ul>
						<a class="waves-effect waves-light btn" data-ng-click="AddArea()">Add Area</a>
					</div>
				</li>
				<li>
					<div class="collapsible-header"><i class="material-icons">chat</i>Tweets</div>
					<div class="collapsible-body">
					</div>
				</li>
			</ul>
			<a class="waves-effect waves-light btn green">Download Config</a>
		</div>
		<div class="formDiv" id="map_canvas"></div>
		<div class="mapmenu cmenu">
			<div class="item addArea" ng-repeat="area in areas" onclick="hideContextMenu();addNewMarker(40.782410,-73.965849);">
				<div class="label">+ {{area.name}} marker</div>
			</div>
			<div class="item" onclick="hideContextMenu();" data-ng-click="makeRectangle();">
				<div class="label">Mass Marker Area</div>
			</div>
		</div>
		<div class="markermenu cmenu">
			<div class="item" onclick="hideContextMenu();deleteMarker();">
				<div class="label">Delete Marker</div>
			</div>
		</div>
		<div class="squaremenu cmenu">
			<div class="item" ng-repeat="area in areas" onclick="hideContextMenu();" data-ng-click="makeCircle();">
				<div class="label">Create Markers {{area.name}}</div>
			</div>
		</div>
		<textarea id="LocationsJSON" ></textarea>
		<textarea id="LocationsJSON_hidden" ></textarea>
	</body>
</html>